name: Deploy NestJS App

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: "22"
        cache: "npm"

    - name: Set npm registry
      run: npm config set registry https://registry.npmjs.org/

    - name: Install ALL dependencies
      run: |
        npm ci --no-audit --prefer-offline

    - name: Build application
      run: |
        npm run build

    - name: Create deployment metadata
      run: |
        echo "Build Date: $(date)" > dist/build-info.txt
        echo "Commit: ${{ github.sha }}" >> dist/build-info.txt
        echo "Branch: ${{ github.ref_name }}" >> dist/build-info.txt
        echo "Deployed by: GitHub Actions" >> dist/build-info.txt

    - name: Create package.json for production
      run: |
        # Create a production package.json with only dependencies
        node -e "
        const pkg = require('./package.json');
        const prodPkg = {
          name: pkg.name,
          version: pkg.version,
          description: pkg.description,
          author: pkg.author,
          license: pkg.license,
          engines: pkg.engines,
          dependencies: pkg.dependencies,
          scripts: {
            start: 'node dist/main.js'
          }
        };
        require('fs').writeFileSync('dist/package.json', JSON.stringify(prodPkg, null, 2));
        "

    - name: Upload build to EC2
      uses: appleboy/scp-action@v0.1.5
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_SSH_KEY }}
        source: "dist/*"
        target: "/home/ec2-user/deploy-temp/"
        strip_components: 0

    - name: Deploy on EC2
      uses: appleboy/ssh-action@v0.1.10
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          set -e

          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          BACKUP_DIR="/opt/apps/backups/vroom-be-api-$TIMESTAMP"
          CURRENT_APP="/opt/apps/vroom-be-api"
          TEMP_DIR="/home/ec2-user/deploy-temp"

          echo "=== Starting Deployment ==="

          sudo mkdir -p /opt/apps/backups
          sudo mkdir -p "$BACKUP_DIR"

          echo "Stopping service..."
          sudo systemctl stop nestjs.service || true

          echo "Backing up current version..."
          if [ -d "$CURRENT_APP" ]; then
            sudo cp -r "$CURRENT_APP"/* "$BACKUP_DIR/" || true
          fi

          echo "Deploying new version..."
          sudo rm -rf "$CURRENT_APP"
          sudo mkdir -p "$CURRENT_APP"
          
          # Copy only the built files and production package.json
          sudo cp -r "$TEMP_DIR/"* "$CURRENT_APP/"

          echo "Fixing permissions..."
          sudo chown -R ec2-user:ec2-user "$CURRENT_APP"

          echo "Installing production dependencies..."
          cd "$CURRENT_APP"
          rm -rf node_modules
          npm ci --omit=dev --no-audit --prefer-offline

          echo "Starting service..."
          sudo systemctl start nestjs.service

          echo "Checking service status..."
          sleep 10
          
          if sudo systemctl is-active --quiet nestjs.service; then
            echo "Service is running successfully!"
            sudo systemctl status nestjs.service --no-pager
          else
            echo ">>> Service failed to start. Checking logs..."
            sudo journalctl -u nestjs.service -n 50 --no-pager
            
            echo ">>> Rolling back..."
            sudo rm -rf "$CURRENT_APP"
            sudo cp -r "$BACKUP_DIR" "$CURRENT_APP"
            sudo chown -R ec2-user:ec2-user "$CURRENT_APP"
            
            cd "$CURRENT_APP"
            rm -rf node_modules
            npm ci --omit=dev --no-audit --prefer-offline
            
            sudo systemctl start nestjs.service
            echo "Rollback complete."
            exit 1
          fi

          echo "Cleanup..."
          rm -rf "$TEMP_DIR"

          echo "=== Deployment Successful ==="
