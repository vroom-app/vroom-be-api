name: Deploy NestJS App

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: "22"
        cache: "npm"

    - name: Install dependencies
      run: |
        npm ci --no-audit

    - name: Build application
      run: |
        npm run build

    - name: Upload built files AND package.json
      uses: appleboy/scp-action@v0.1.5
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_SSH_KEY }}
        source: "dist/*,package.json"  # Send both
        target: "/home/ec2-user/deploy-temp/"
        strip_components: 0

    - name: Deploy on EC2
      uses: appleboy/ssh-action@v0.1.10
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          set -e

          CURRENT_APP="/opt/apps/vroom-be-api"
          TEMP_DIR="/home/ec2-user/deploy-temp"

          echo "=== Starting Deployment ==="

          echo "Stopping service..."
          sudo systemctl stop nestjs.service || true

          echo "Deploying new version..."
          sudo rm -rf "$CURRENT_APP"
          sudo mkdir -p "$CURRENT_APP"
          
          # Copy everything from temp
          sudo cp -r "$TEMP_DIR/"* "$CURRENT_APP/"

          echo "Fixing permissions..."
          sudo chown -R ec2-user:ec2-user "$CURRENT_APP"

          echo "Installing production dependencies..."
          cd "$CURRENT_APP"
          rm -rf node_modules
          
          # Use your existing package.json with only production deps
          npm install --production --no-audit

          echo "Starting service..."
          sudo systemctl start nestjs.service

          echo "Checking service status..."
          sleep 5
          
          if sudo systemctl is-active --quiet nestjs.service; then
            echo "✅ Service is running successfully!"
            sudo systemctl status nestjs.service --no-pager
          else
            echo "❌ Service failed. Checking logs..."
            sudo journalctl -u nestjs.service -n 30 --no-pager
            exit 1
          fi

          echo "Cleanup..."
          rm -rf "$TEMP_DIR"

          echo "=== Deployment Successful ==="
